<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swerve Helper - Capture Pages via Proxy</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .intro {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 16px;
            margin-bottom: 24px;
            border-radius: 4px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="url"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input[type="url"]:focus, textarea:focus {
            outline: none;
            border-color: #2196f3;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #2196f3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976d2;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 6px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .csp-info {
            background: #fff8e1;
            border-left: 4px solid #ff9800;
            padding: 16px;
            margin-bottom: 24px;
            border-radius: 4px;
        }

        .csp-info h3 {
            margin-bottom: 8px;
            color: #ef6c00;
        }

        .options {
            margin-top: 20px;
        }

        .option {
            background: #f5f5f5;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .option h4 {
            margin-bottom: 8px;
            color: #333;
        }

        .option p {
            color: #666;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ Swerve Helper</h1>
        
        <div class="intro">
            <p><strong>Having trouble with the Swerve bookmarklet?</strong></p>
            <p>This helper page can capture web pages when strict Content Security Policies (CSP) block the bookmarklet from running directly.</p>
        </div>

        <div class="csp-info">
            <h3>Why Use This Helper?</h3>
            <p>Some websites have strict security policies that prevent bookmarklets from running. This helper page works around those limitations by fetching the page content on your behalf and sending it to Swerve.</p>
        </div>

        <form id="captureForm">
            <div class="form-group">
                <label for="urlInput">Page URL to Capture:</label>
                <input type="url" id="urlInput" placeholder="https://example.com/article" required>
                <small style="color: #666; display: block; margin-top: 4px;">
                    Paste the URL of the page you want to capture and send to Swerve.
                </small>
            </div>

            <div class="form-group">
                <label for="endpointInput">Swerve Endpoint (Optional):</label>
                <input type="url" id="endpointInput" placeholder="https://service.example.com/ingest">
                <small style="color: #666; display: block; margin-top: 4px;">
                    Leave blank to use the default endpoint. Only change if you're using a custom Swerve service.
                </small>
            </div>

            <div class="form-group">
                <label for="notesInput">Notes (Optional):</label>
                <textarea id="notesInput" placeholder="Add any context or notes about this capture..."></textarea>
            </div>

            <div class="button-group">
                <button type="submit" class="btn-primary">ðŸš€ Capture Page</button>
                <button type="button" class="btn-secondary" onclick="clearForm()">Clear</button>
            </div>
        </form>

        <div id="status" class="status"></div>

        <div class="options">
            <div class="option">
                <h4>ðŸ”– Alternative: Try the Bookmarklet Again</h4>
                <p>Sometimes CSP issues are temporary. You can try the bookmarklet on the target page again, or try it on a different page from the same site.</p>
            </div>
            
            <div class="option">
                <h4>ðŸ“‹ Alternative: Manual Copy-Paste</h4>
                <p>If proxy capture doesn't work either, you can manually copy the page content and paste it into your Swerve service dashboard.</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            defaultEndpoint: 'https://service.example.com/ingest',
            version: '0.1.0',
            timeout: 30000,
            proxyEndpoint: 'https://service.example.com/proxy-capture' // This would be a server-side endpoint
        };

        // Initialize the form with URL parameter if provided
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const targetUrl = urlParams.get('url');
            
            if (targetUrl) {
                document.getElementById('urlInput').value = decodeURIComponent(targetUrl);
            }
        });

        // Handle form submission
        document.getElementById('captureForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const url = document.getElementById('urlInput').value.trim();
            const endpoint = document.getElementById('endpointInput').value.trim() || CONFIG.defaultEndpoint;
            const notes = document.getElementById('notesInput').value.trim();
            
            if (!url) {
                showStatus('Please enter a valid URL', 'error');
                return;
            }

            try {
                showStatus('Fetching page content...', 'loading');
                await captureUrl(url, endpoint, notes);
            } catch (error) {
                console.error('Capture failed:', error);
                showStatus(`Capture failed: ${error.message}`, 'error');
            }
        });

        /**
         * Capture a URL via proxy and send to Swerve
         */
        async function captureUrl(url, endpoint, notes) {
            // In a real implementation, this would:
            // 1. Send the URL to a server-side proxy that can fetch the page
            // 2. The proxy would return the page content, metadata, etc.
            // 3. We'd then send that data to the Swerve endpoint
            
            // For now, we'll simulate this process and show what would happen
            showStatus('Connecting to proxy service...', 'loading');
            
            // Simulate proxy fetch delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Create simulated payload (in reality, this would come from the proxy)
            const payload = {
                version: "0",
                page: {
                    url: url,
                    title: "Proxy-captured page", // Would come from actual fetch
                    referrer: window.location.href,
                    userAgent: navigator.userAgent,
                    viewport: { width: 1440, height: 900 }, // Default values for proxy
                    scroll: { x: 0, y: 0 }
                },
                snapshot: {
                    html: `<!-- Proxy-captured content for ${url} -->`,
                    selectionText: "",
                    selectionHtml: "",
                    capturedAt: new Date().toISOString()
                },
                transfer: {
                    encoding: "plain",
                    chunk: { index: 0, count: 1 }
                },
                client: {
                    bookmarkletVersion: CONFIG.version,
                    language: navigator.language,
                    captureMethod: "proxy-helper",
                    notes: notes || undefined
                }
            };

            showStatus('Sending to Swerve...', 'loading');
            
            // Send to Swerve endpoint
            const response = await fetch(endpoint, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            
            showStatus(
                `âœ… Page captured successfully! ${result.trackUrl ? `<br><a href="${result.trackUrl}" target="_blank" style="color: inherit; text-decoration: underline;">Track job progress</a>` : ''}`,
                'success'
            );
        }

        /**
         * Show status message
         */
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
            statusEl.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        /**
         * Clear the form
         */
        function clearForm() {
            document.getElementById('urlInput').value = '';
            document.getElementById('endpointInput').value = '';
            document.getElementById('notesInput').value = '';
            document.getElementById('status').style.display = 'none';
        }

        /**
         * NOTE FOR IMPLEMENTATION:
         * 
         * In a real deployment, you would need:
         * 
         * 1. A server-side proxy endpoint that can:
         *    - Accept a URL parameter
         *    - Fetch the page content server-side (bypassing client-side CSP)
         *    - Extract metadata (title, etc.)
         *    - Return structured data back to this helper page
         * 
         * 2. CORS configuration on both:
         *    - The proxy service (to allow this helper page to call it)
         *    - The Swerve ingest endpoint (to allow direct posts from this page)
         * 
         * 3. Rate limiting and abuse prevention on the proxy service
         * 
         * 4. Error handling for:
         *    - Pages that can't be fetched (404, 403, etc.)
         *    - Pages that are too large
         *    - Timeout scenarios
         * 
         * The current implementation is a functional prototype that demonstrates
         * the user experience and data flow.
         */
    </script>
</body>
</html>